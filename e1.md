Here’s a detailed expert response addressing your five questions as they relate to Jambonz, Docker Compose, drachtio-srf/drachtio-server (Node.js), SIP, and multi-tenant header handling:

***

## 1. drachtio-srf createB2BUA custom header behavior

**Expected:**  
- According to the official drachtio-srf API and code examples, the `headers` property in `createB2BUA` *is* designed to inject custom SIP headers (including `X-Account-Sid`) into the *outgoing* INVITE sent to the B-leg.  
- If you pass an object like `{ 'X-Account-Sid': 'xxxx' }`, it should appear in the B-leg SIP INVITE unless overridden or filtered elsewhere (e.g., in drachtio-server config or by a proxy/SBC).[1][2]
- The advanced option `proxyRequestHeaders` is meant only for copying headers from the A-leg to the B-leg “unchanged.” If you want to insert or override, use `headers` only.[2]

**Conclusion:**  
- No extra configuration should be necessary for custom `X-` headers; so if the header is missing *on-wire*, there’s either a bug or interference outside your Node.js code.

***

## 2. SIP protocol compliance and X- headers

**SIP Behavior:**  
- The SIP RFC does *not* prevent `X-` custom headers; they are “extension” headers and should flow end-to-end unless filtered by an intermediary.  
- Some strict SIP stack implementations (or security policies) might strip unknown `X-` headers, but this is NOT default for drachtio-server.[3][1]
- Standard SIP proxies (including B2BUA) may drop headers for security/privacy, but drachtio by default is not known to do this for custom `X-` headers.

***

## 3. Debugging: Inspecting actual SIP messages in Docker

**Best Practice:**  
- **Use SIP-level packet capture:** Attach `tcpdump` or `ngrep -W byline port 5060` on the network interfaces of the Docker containers to capture and inspect the SIP INVITE on the wire between SBC-Inbound and Feature Server.
- Alternatively, enable **drachtio-server SIP tracing** in both containers for full raw message logging (see drachtio-server documentation for enabling logging to stdout or file).[4]
- **Caution:** Docker’s NAT networking means you may need to run your capture on the correct bridge interface for container-to-container SIP traffic.

***

## 4. Alternative approaches for tenant/account context

**If custom headers can't be trusted to survive B2BUA hops:**

- **SIP URI user params:** Embed context in the SIP URI user part or as a URI parameter (e.g. `sip:user;account_sid=xxx@feature-server`) for robust, protocol-compliant delivery.
- **To/From display name:** Encapsulate tenant info in the display name, though messy—useful for some non-invasive contexts.
- **Authenticated identity:** If you control all endpoints, encode context in the authenticated SIP user’s credentials or use a known mapping table.
- **SIP INFO or re-INVITE:** For multi-stage flows where context may be lost, re-send identification over a secondary SIP INFO, though less elegant.

***

## 5. Version incompatibility caveats

- There have been changes in how **drachtio-server** and **drachtio-srf** handle SIP header normalization and message passing over time, especially targeting privacy/security and header canonicalization.
- Known issues are sometimes discussed in the GitHub issues for the project, especially around major version upgrades or Node.js compatibility changes.[5]
- If you’re using a mix of *latest* and *older* versions of drachtio-srf and drachtio-server, header behavior could break silently or custom SIP headers may be stripped.

**Action:** Make sure the versions of drachtio-srf (Node) and drachtio-server (container) match the recommended combinations from drachtio's documentation or release notes.

***

### Quick Diagnostics Checklist

- Confirm your `docker-compose.yml` does NOT have environment config (in drachtio-server, or underlying sofia stack) that filters/blocks custom headers.
- Use SIP traces and/or pcap to confirm if headers are present right from Node.js app to drachtio-server (app-level vs. SIP-level test).
- Test with bare-bones custom headers (only a single `X-Account-Sid` and nothing else) to rule out any conflicts or max header count issues.
- Inspect drachtio-server logs in debug/trace mode.

***

#### References







If you need specific code-level troubleshooting steps or an example SIP trace filter to confirm the header, let me know!

[1](https://drachtio.org/docs)
[2](https://drachtio.org/docs/api)
[3](https://blog.evaristesys.com/2016/02/04/sip-udp-fragmentation-and-kamailio-the-sip-header-diet/)
[4](https://drachtio.org/docs/drachtio-server)
[5](https://github.com/drachtio/drachtio-srf)
[6](https://drachtio.org/api)
[7](https://www.npmjs.com/package/drachtio-srf/v/4.2.8)
[8](https://drachtio.github.io/drachtio-srf/)
[9](https://github.com/drachtio/drachtio-server)
[10](https://www.npmjs.com/package/drachtio-srf)
[11](https://github.com/davehorton/drachtio-srf/issues/17)
[12](https://docs.expertflow.com/cx/4.5.2/siprec-based-recording-using-a-drachtio-server-and)
[13](https://docs.oracle.com/cd/E80921_01/html/esbc_ecz740_configuration/GUID-021D2A82-5D04-446A-A045-D08ED7A46142.htm)
[14](https://stackoverflow.com/questions/7042340/error-cant-set-headers-after-they-are-sent-to-the-client)
[15](https://stackoverflow.com/questions/34024562/what-parameters-need-to-be-modified-in-an-sdp-rtp-header-when-relaying-media-thr)
[16](https://github.com/davehorton/drachtio/blob/master/Readme.md)